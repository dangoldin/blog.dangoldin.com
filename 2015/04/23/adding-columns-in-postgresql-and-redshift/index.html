<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Adding columns in PostgreSQL and Redshift - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="Adding a database column in SQL is easy, except when it's not."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2015/04/23/adding-columns-in-postgresql-and-redshift/"><meta property="og:title" content="Adding columns in PostgreSQL and Redshift"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="Adding a database column in SQL is easy, except when it's not."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Adding columns in PostgreSQL and Redshift"><meta name=twitter:description content="Adding a database column in SQL is easy, except when it's not."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2015/04/23/adding-columns-in-postgresql-and-redshift/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=image/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-36313127-1');</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Adding columns in PostgreSQL and Redshift</h1><div class="mb-md-4 meta"><span class="date middot" title="Thu Apr 23 2015 00:00:00 UTC">2015-04-23</span>
<span class="reading-time middot">4 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/devops>devops</a></li><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>A frequent event when working with a SQL database is adding a column. Ideally, you’d want to add this column before or after another one that makes sense rather than all the way at the end. MySQL makes this straightforward since you can use the AFTER keyword when adding a column to specify exactly where it should be added. PostgreSQL and Redshift make this difficult since all new columns are automatically added at the end.</p><p>Normally, this isn’t a problem in most cases since you just write a query to specify the desired column order but it makes doing a simple “SELECT *” more annoying and will break naive jobs that rely on a particular column order.</p><p>The accepted solution is to create a new table with the proper structure, migrate the data from the original table while using a default value for the new column, drop or rename the original table, and then rename the new table with the original name. It’s a lot easier to see this in code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- The original table
</span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
  name varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#75715e>-- Let&#39;s say we need to add an age column
</span><span style=color:#75715e>-- Create the new table
</span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_new (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
  name varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>,
  age int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#75715e>-- Migrate the data
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> test_new
  <span style=color:#66d9ef>SELECT</span> id, name, <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>FROM</span> test;

<span style=color:#75715e>-- Backup the old table
</span><span style=color:#75715e></span><span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TABLE</span> test <span style=color:#66d9ef>TO</span> test_old;

<span style=color:#75715e>-- Rename the new table to have the original name
</span><span style=color:#75715e></span><span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TABLE</span> test_new <span style=color:#66d9ef>TO</span> test;

<span style=color:#75715e>-- If all looks good, drop the old table
</span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> test_old;</code></pre></div><p>One issue with this approach is that if the table is very large, it will take a long time to migrate the data from the original to the new table. In this case a possible approach is to do it piecemeal - if you know you only need recent data you can migrate a subset of the data first to get the table ready, do the rename, and then migrate the rest. In code again:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- The original table
</span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
  name varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#75715e>-- Let&#39;s say we need to add an age column
</span><span style=color:#75715e>-- Create the new table
</span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_new (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
  name varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>,
  age int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#75715e>-- Migrate some of the data
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> test_new
  <span style=color:#66d9ef>SELECT</span> id, name, <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>FROM</span> test
  <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1000000</span>;

<span style=color:#75715e>-- Backup the old table
</span><span style=color:#75715e></span><span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TABLE</span> test <span style=color:#66d9ef>TO</span> test_old;

<span style=color:#75715e>-- Rename the new table to have the original name
</span><span style=color:#75715e></span><span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TABLE</span> test_new <span style=color:#66d9ef>TO</span> test;

<span style=color:#75715e>-- Migrate the rest of the data
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> test
  <span style=color:#66d9ef>SELECT</span> id, name, <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>FROM</span> test_old
  <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1000000</span>;

<span style=color:#75715e>-- If all looks good, drop the old table
</span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> test_old;</code></pre></div><p>If you know for a fact that it&rsquo;s not important to have the old data immediately available you can opt to rename the original table, create the new table, and only then migrate the data. This allows queries that need to write data to this table to complete immediately. The risk is that the legacy data will only be available after the migration completes. The last code block:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- The original table
</span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
  name varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#75715e>-- Let&#39;s say we need to add an age column
</span><span style=color:#75715e>-- Create the new table
</span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_new (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
  name varchar(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>,
  age int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#75715e>-- Backup the old table
</span><span style=color:#75715e></span><span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TABLE</span> test <span style=color:#66d9ef>TO</span> test_old;

<span style=color:#75715e>-- Rename the new table to have the original name
</span><span style=color:#75715e></span><span style=color:#66d9ef>RENAME</span> <span style=color:#66d9ef>TABLE</span> test_new <span style=color:#66d9ef>TO</span> test;

<span style=color:#75715e>-- Migrate the data
</span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> test
  <span style=color:#66d9ef>SELECT</span> id, name, <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>FROM</span> test_old;

<span style=color:#75715e>-- If all looks good, drop the old table
</span><span style=color:#75715e></span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> test_old;</code></pre></div><p>The first scenario handles having columns in the right order but the other two can be useful on MySQL as well when tables are large and performance is critical. For high load databases, transactions can be used to make sure that the renames are done atomically - this will avoid an intermittent query writing to a non existent database. It&rsquo;s surprising how a task as simple as adding a column can evolve into a large problem with a variety of solutions when running into a variety of constraints.</p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2015/04/19/dont-scrape-into-a-dropbox-folder/>« Don't scrape into a Dropbox folder</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2015/04/26/aws-service-limits/>AWS service limits »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script></body></html>