<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>More MySQL fun - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="Doing a group by on a derived column can be dangerous if it has the same name as one of the originals. It's much better to be explicit with the columns and group by you're using."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2015/11/21/more-mysql-fun/"><meta property="og:title" content="More MySQL fun"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="Doing a group by on a derived column can be dangerous if it has the same name as one of the originals. It's much better to be explicit with the columns and group by you're using."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="More MySQL fun"><meta name=twitter:description content="Doing a group by on a derived column can be dangerous if it has the same name as one of the originals. It's much better to be explicit with the columns and group by you're using."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2015/11/21/more-mysql-fun/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/image/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-36313127-1');</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">More MySQL fun</h1><div class="mb-md-4 meta"><span class="date middot" title="Sat Nov 21 2015 00:00:00 UTC">2015-11-21</span>
<span class="reading-time middot">2 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/sql>sql</a></li><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>I had a bit of fun with MySQL earlier this week when trying to explain a non obvious “group by” behavior. It’s fairly common to want to manipulate a field in order to transform it into something more useful. The difficulty arises when you want to keep the original name. Below is some SQL code that highlights the odd behavior.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>exists</span> dan_test;

<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> dan_test (
  id int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>,
  id2 int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span>
);

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> dan_test (id, id2) <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>3</span>);

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> dan_test;

<span style=color:#66d9ef>select</span> id, <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>else</span> id <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> id, id2
<span style=color:#66d9ef>from</span> dan_test;

<span style=color:#66d9ef>select</span> id, <span style=color:#66d9ef>sum</span>(id2)
<span style=color:#66d9ef>from</span> dan_test
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> id;

<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>else</span> id <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> id, <span style=color:#66d9ef>sum</span>(id2)
<span style=color:#66d9ef>from</span> dan_test
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> id;

<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>else</span> id <span style=color:#66d9ef>end</span> <span style=color:#66d9ef>as</span> new_id, <span style=color:#66d9ef>sum</span>(id2)
<span style=color:#66d9ef>from</span> dan_test
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> new_id;
<span style=color:#960050;background-color:#1e0010>{</span><span style=color:#f92672>%</span> endhighlight <span style=color:#66d9ef>sql</span> <span style=color:#f92672>%</span><span style=color:#960050;background-color:#1e0010>}</span>

<span style=color:#66d9ef>With</span> the <span style=color:#66d9ef>second</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>last</span> query it<span style=color:#960050;background-color:#1e0010>’</span>s <span style=color:#66d9ef>not</span> obvious which id field the <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>is</span> referring <span style=color:#66d9ef>to</span>: the original <span style=color:#66d9ef>from</span> the <span style=color:#66d9ef>table</span> <span style=color:#66d9ef>or</span> the derived field<span style=color:#f92672>?</span> It turns <span style=color:#66d9ef>out</span> it<span style=color:#960050;background-color:#1e0010>’</span>s the original field which can cause problems <span style=color:#66d9ef>if</span> you<span style=color:#960050;background-color:#1e0010>’</span>re unaware <span style=color:#66d9ef>of</span> this subtlety. There <span style=color:#66d9ef>are</span> a few different ways <span style=color:#66d9ef>to</span> deal <span style=color:#66d9ef>with</span> this situation, <span style=color:#66d9ef>including</span> <span style=color:#66d9ef>grouping</span> <span style=color:#66d9ef>by</span> the derivation formula, but my favorite <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>to</span> use a brand <span style=color:#66d9ef>new</span> field <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>in</span> the <span style=color:#66d9ef>last</span> example above.</code></pre></div></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2015/11/19/adhoc-task-management/>« Adhoc task management</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2015/11/22/why-are-netflix-and-spotify-so-different/>Why are Netflix and Spotify so different? »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script></body></html>