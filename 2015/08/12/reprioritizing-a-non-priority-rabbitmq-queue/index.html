<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<title> Reprioritizing a non priority RabbitMQ queue - Dan Goldin </title>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=referrer content="no-referrer">
<meta name=description content="Sometimes it's necessary to reprioritize tasks on a RabbitMQ queue. One way to do it is to get every task on there and use shell scripting to requeue then in the correct order.">
<meta property="og:site_name" content="Dan Goldin">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:url" content="/2015/08/12/reprioritizing-a-non-priority-rabbitmq-queue/">
<meta property="og:title" content="Reprioritizing a non priority RabbitMQ queue">
<meta property="og:image" content="/image/photo.jpg">
<meta property="og:description" content="Sometimes it's necessary to reprioritize tasks on a RabbitMQ queue. One way to do it is to get every task on there and use shell scripting to requeue then in the correct order.">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:site content="@dangoldin">
<meta name=twitter:creator content="@dangoldin">
<meta name=twitter:title content="Reprioritizing a non priority RabbitMQ queue">
<meta name=twitter:description content="Sometimes it's necessary to reprioritize tasks on a RabbitMQ queue. One way to do it is to get every task on there and use shell scripting to requeue then in the correct order.">
<meta name=twitter:image content="/image/photo.jpg">
<link rel=canonical href=/2015/08/12/reprioritizing-a-non-priority-rabbitmq-queue/>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous>
<link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css>
<link rel=stylesheet href=/css/custom.css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/favicon.png>
<link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36313127-1')</script>
</head>
<body>
<div class="my-4 my-lg-5 header">
<div class=container>
<div class=row>
<div class="col-auto offset-lg-2 d-none d-lg-block">
<a href=/>
<img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo>
</a>
</div>
<div class="col-auto align-self-center mr-auto">
<a href=/>
<h1 class=name>Dan Goldin</h1>
</a>
<ul class="nav nav-primary">
<li class=nav-item>
<a class="nav-link text-home" href=/>
Home
</a>
</li>
<li class=nav-item>
<a class="nav-link text-about" href=/about/>
About
</a>
</li>
<li class=nav-item>
<a class="nav-link text-lore" href=/lore/>
Lore
</a>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class=content>
<div class=container>
<div class="row justify-content-center">
<div class="col-sm-12 col-lg-8">
<h1 class="mx-0 mx-md-4 blog-post-title">Reprioritizing a non priority RabbitMQ queue</h1>
<div class="mb-md-4 meta">
<span class="date middot" title="Wed Aug 12 2015 00:00:00 UTC">
2015-08-12
</span>
<span class="reading-time middot">
2 min read
</span>
<div class="d-none d-md-inline tags">
<ul class="list-unstyled d-inline">
<li class="d-inline middot">
<a href=/tags/code>code</a>
</li>
</ul>
</div>
<div class="d-none d-md-inline tags">
<ul class="list-unstyled d-inline">
</ul>
</div>
</div>
<div class="markdown blog-post-content">
<p>Earlier today we had a hiccup where we had a bunch of messages piled up on a RabbitMQ queue that were not being consumed. Some of these tasks were very quick data loads while others were more involved jobs that could take multiple minutes to run. Normally these are distributed relatively evenly across the day so it’s not a problem but in this case we had hundreds of tasks in a random order and we wanted to shuffle them around such that the data load tasks executed first so that the data would be quickly accessible to other higher priority jobs.</p>
<p>Luckily, we remembered we had some old shell commands that helped us backup and restore a RabbitMQ queue so it only required a bit of scripting to come up with a sequence of commands to do exactly what we wanted. The script works by dumping the contents of the queue into a file, extracting the message field, filtering the messages into the desired buckets, turning them into queue addition commands, and executing the resulting files.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># Dump the contents of the queue to a file.</span>
<span style=color:#75715e># To be safe requeue the messages and do a manual purge when</span>
<span style=color:#75715e># we confirm the data looks right.</span>
./rabbitmqadmin get queue<span style=color:#f92672>=</span>data_queue requeue<span style=color:#f92672>=</span>true count<span style=color:#f92672>=</span><span style=color:#ae81ff>2000</span> &gt; tasks.log

<span style=color:#75715e># 1 - Get the appropriate field (in our case the fifth one)</span>
<span style=color:#75715e># 2 - Remove the header rows</span>
<span style=color:#75715e># 3 - Trim the line</span>
<span style=color:#75715e># 4 - Prepend the publish command and turn the task message string into an argument</span>
cut -d<span style=color:#e6db74>&#39;|&#39;</span> -f5 tasks.log | sed <span style=color:#e6db74>&#39;$d&#39;</span> | sed <span style=color:#e6db74>&#39;1,3d&#39;</span> | sed <span style=color:#e6db74>&#39;s/^ *//;s/*$//&#39;</span> | sed -e <span style=color:#e6db74>&#34;s/^/.\/rabbitmqadmin publish exchange=data_queue.task routing_key=standard payload=&#39;/&#34;</span> | sed -e <span style=color:#e6db74>&#34;s/</span>$<span style=color:#e6db74>/&#39;/&#34;</span> &gt; tasks.clean

<span style=color:#75715e># Split the tasks into two pieces</span>
cat tasks.clean | grep log &gt; tasks.clean1
cat tasks.clean | grep -v log &gt; tasks.clean2

<span style=color:#75715e># Queue the tasks in the appropriate order</span>
sh tasks.clean1
sh tasks.clean2</code></pre></div>
</div>
<div class=navigation>
<div class=row>
<div class="col-12 col-lg-6">
<div class="mx-0 mx-md-4 mt-4 text-left">
<a href=/2015/08/09/static-site-search/>« Static site search</a>
</div>
</div>
<div class="col-12 col-lg-6">
<div class="mx-0 mx-md-4 mt-4 text-right">
<a href=/2015/08/15/generating-vs-filtering/>Generating vs filtering »</a>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section id=comments>
<div class="py-3 content">
<div class=container>
<div class="row justify-content-center">
<div class="col-sm-12 col-lg-8">
<div class=comments>
<script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script>
</div>
</div>
</div>
</div>
</div>
</section>
<div class="my-4 footer">
<div class=container>
<div class="row justify-content-center">
<div class="col-sm-12 col-lg-8">
<hr>
</div>
</div>
<div class="row justify-content-center">
<div class="col-sm-12 col-lg-2">
<div class="mx-0 mx-md-4 site-copyright">
© 2021 Dan Goldin
</div>
</div>
<div class="col-sm-12 col-lg-6">
<div class="mx-0 mx-md-4 site-social">
<ul>
<li><a href=mailto:dan@dangoldin.com>Contact</a></li>
<li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li>
<li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li>
<li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li>
<li><a href=/index.xml class=mr-0>RSS</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script>
<script>window.addEventListener('load',function(){hljs.initHighlighting()},!0)</script>
<script src=/js/math-code.js></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>