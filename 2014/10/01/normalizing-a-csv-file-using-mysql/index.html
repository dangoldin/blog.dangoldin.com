<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Normalizing a CSV file using MySQL - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="I had a CSV of fantasy footabll stats and used MySQL to normalize it."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2014/10/01/normalizing-a-csv-file-using-mysql/"><meta property="og:title" content="Normalizing a CSV file using MySQL"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="I had a CSV of fantasy footabll stats and used MySQL to normalize it."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Normalizing a CSV file using MySQL"><meta name=twitter:description content="I had a CSV of fantasy footabll stats and used MySQL to normalize it."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2014/10/01/normalizing-a-csv-file-using-mysql/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36313127-1')</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Normalizing a CSV file using MySQL</h1><div class="mb-md-4 meta"><span class="date middot" title="Wed Oct 1 2014 00:00:00 UTC">2014-10-01</span>
<span class="reading-time middot">5 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/data>data</a></li><li class="d-inline middot"><a href=/tags/sql>sql</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>As part of my preparation for the Intro to MySQL class I decided to put together a dataset we’d be able to explore over the course of the class. While trying to think of an interesting dataset to use I remembered I had a script that scraped Yahoo’s fantasy football projections for the 2014 seasons that I used to prepare for my draft. The only issue was that the script generated a CSV file so I had to go through a series of steps to turn it into a clean, relational database. I thought it would be useful to share the commands below and provide some context for those interested in learning more about MySQL and the data import/cleanup process.</p><p>The first step is to create the table that we&rsquo;ll be loading the CSV file into<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> stats;
use <span style=color:#66d9ef>database</span> stats;

<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> orig_stats (
  week int,
  name varchar(<span style=color:#ae81ff>100</span>),
  <span style=color:#66d9ef>position</span> varchar(<span style=color:#ae81ff>20</span>),
  opp varchar(<span style=color:#ae81ff>50</span>),
  passing_yds float,
  passing_tds float,
  passing_int float,
  rushing_att float,
  rushing_yds float,
  rushing_tds float,
  receiving_tgt float,
  receiving_rec float,
  receiving_yds float,
  receiving_tds float,
  return_tds float,
  twopt float,
  fumbles float,
  points float
);</code></pre></div></p><p>Now we load the CSV file into the table making sure to specify the options properly. In my case this took a few attempts to deal with the line endings.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>LOAD</span> <span style=color:#66d9ef>DATA</span> INFILE <span style=color:#e6db74>&#39;/tmp/stats-2014.csv&#39;</span>
<span style=color:#66d9ef>INTO</span> <span style=color:#66d9ef>TABLE</span> orig_stats
FIELDS TERMINATED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;,&#39;</span>
LINES TERMINATED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;\r\n&#39;</span>
<span style=color:#66d9ef>IGNORE</span> <span style=color:#ae81ff>1</span> LINES ;</code></pre></div></p><p>Next step is to create the tables we want to end up with. In my case I wanted to normalize the data which required designed a new set of tables. A big assumption made here was that a player will not get traded from one team to another. This is definitely not correct in the real world but it is good enough for this exercise. If we wanted to allow for trades we would have a separate table that would map a player to a team by week.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> teams (
  id int unsigned <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
  name varchar(<span style=color:#ae81ff>100</span>),
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id),
  <span style=color:#66d9ef>UNIQUE</span> (name)
);

<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> positions (
  id int unsigned <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
  name varchar(<span style=color:#ae81ff>10</span>),
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id),
  <span style=color:#66d9ef>UNIQUE</span> (name)
);

<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> players (
  id int unsigned <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
  name varchar(<span style=color:#ae81ff>100</span>),
  position_id int,
  team_id int,
  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id)
);

<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> schedule (
  week int,
  home_id int,
  away_id int,
  <span style=color:#66d9ef>UNIQUE</span> (week, home_id, away_id)
);

<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> stats (
  week int,
  player_id int,
  passing_yds float,
  passing_tds float,
  passing_int float,
  rushing_att float,
  rushing_yds float,
  rushing_tds float,
  receiving_tgt float,
  receiving_rec float,
  receiving_yds float,
  receiving_tds float,
  return_tds float,
  twopt float,
  fumbles float,
  points float
);</code></pre></div></p><p>Now it&rsquo;s on to the hard part. We want to take the data in the original stats table and convert into a properly normalized data set. The strategy here is to start with the simple tables and work our way up to the more complicated ones leveraging the normalized data we created at each step. The first two tables are teams and positions and we can derive them from the &ldquo;position&rdquo; field in the original stats table by splitting the position field into two and realizing that the left side is the team and the right side is the position of given the player.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> teams
  (name)
  <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>distinct</span>(substring_index(<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39; - &#39;</span>, <span style=color:#ae81ff>1</span>))
  <span style=color:#66d9ef>from</span> orig_stats <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>position</span>;

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> positions
  (name)
  <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>distinct</span>(substring_index(<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39; - &#39;</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)) <span style=color:#66d9ef>as</span> pos
  <span style=color:#66d9ef>from</span> orig_stats <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> pos;</code></pre></div></p><p>To generate the players table, we get the player position and team from the stats table and then find the associated ids from the teams and positions tables. The key assumption here is that there are no two players with the same name, on the same team, and the same position.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> players
  (name, position_id, team_id)
  <span style=color:#66d9ef>select</span> p.name, pos.id, t.id
  <span style=color:#66d9ef>from</span> (
    <span style=color:#66d9ef>select</span> name, <span style=color:#66d9ef>position</span>,
      substring_index(<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39; - &#39;</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> pos,
      substring_index(<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39; - &#39;</span>, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> team
    <span style=color:#66d9ef>from</span> orig_stats
    <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> name, <span style=color:#66d9ef>position</span>, pos, team
  ) p
  <span style=color:#66d9ef>join</span> teams t <span style=color:#66d9ef>on</span> t.name <span style=color:#f92672>=</span> p.team
  <span style=color:#66d9ef>join</span> positions pos <span style=color:#66d9ef>on</span> pos.name <span style=color:#f92672>=</span> p.pos;</code></pre></div></p><p>We can figure out the schedule by getting a list of the unique matchups in the original stats table. Since the games are symmetric we only need to look at the rows that are home games.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> schedule
  (week, home_id, away_id)
  <span style=color:#66d9ef>select</span> s.week, t1.id, t2.id
  <span style=color:#66d9ef>from</span> (
    <span style=color:#66d9ef>select</span> week,
      substring_index(<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39; - &#39;</span>, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> home_team,
      substring_index(opp, <span style=color:#e6db74>&#39; vs &#39;</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> away_team
    <span style=color:#66d9ef>from</span> orig_stats s
    <span style=color:#66d9ef>where</span> opp <span style=color:#66d9ef>like</span> <span style=color:#e6db74>&#39;%vs%&#39;</span>
    <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> week, home_team, away_team
  ) s
  <span style=color:#66d9ef>join</span> teams t1 <span style=color:#66d9ef>on</span> t1.name <span style=color:#f92672>=</span> s.home_team
  <span style=color:#66d9ef>join</span> teams t2 <span style=color:#66d9ef>on</span> t2.name <span style=color:#f92672>=</span> s.away_team
  <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> s.week, t1.id, t2.id;</code></pre></div></p><p>Putting everything together we generate the new stats table by doing the relevant lookups in the tables we created. We can ignore the redundant fields (name, position, opponent) and the only thing we need to watch out for is duplicate players. In this case there are two names, Zach Miller and Alex Smith, that need to be made &ldquo;unique&rdquo; by also looking at their team.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> stats
  (week, player_id,
  passing_yds, passing_tds, passing_int, rushing_att, rushing_yds, rushing_tds,
  receiving_tgt, receiving_rec, receiving_yds, receiving_tds, return_tds,
  twopt, fumbles, points)
  <span style=color:#66d9ef>select</span> s.week, p.id,
  passing_yds, passing_tds, passing_int, rushing_att, rushing_yds, rushing_tds,
  receiving_tgt, receiving_rec, receiving_yds, receiving_tds, return_tds,
  twopt, fumbles, points
  <span style=color:#66d9ef>from</span> orig_stats s
  <span style=color:#66d9ef>join</span> teams t <span style=color:#66d9ef>on</span> substring_index(s.<span style=color:#66d9ef>position</span>, <span style=color:#e6db74>&#39; - &#39;</span>, <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> t.name
  <span style=color:#66d9ef>join</span> players p <span style=color:#66d9ef>on</span> s.name <span style=color:#f92672>=</span> p.name <span style=color:#66d9ef>and</span> p.team_id <span style=color:#f92672>=</span> t.id;</code></pre></div></p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2014/09/27/mobile-web-browsing-and-javelin/>« Mobile web browsing and Javelin</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2014/10/04/xkcd-movie-quotes-by-android/>XKCD movie quotes by Android »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting()},!0)</script><script src=/js/math-code.js></script><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>