<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Improving Jekyll generation speed for AMP pages - Dan Goldin
</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="Every since I moved my blog over to AMP it took a very long time to build it due to the CSS inlining requirement. Now it takes 15 seconds."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2017/11/23/improving-jekyll-generation-speed-for-amp-pages/"><meta property="og:title" content="Improving Jekyll generation speed for AMP pages"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="Every since I moved my blog over to AMP it took a very long time to build it due to the CSS inlining requirement. Now it takes 15 seconds."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Improving Jekyll generation speed for AMP pages"><meta name=twitter:description content="Every since I moved my blog over to AMP it took a very long time to build it due to the CSS inlining requirement. Now it takes 15 seconds."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2017/11/23/improving-jekyll-generation-speed-for-amp-pages/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-36313127-1")</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Improving Jekyll generation speed for AMP pages</h1><div class="mb-md-4 meta"><span class="date middot" title='Thu Nov 23 2017 00:00:00 UTC'>2017-11-23
</span><span class="reading-time middot">3 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>Last September I migrated my blog over to AMP which entailed a variety of challenges ranging from converting every img tag to an amp-img tag with some additional metadata to figuring out how to support Disqus. I tackled the critical ones but the one I never got to was speeding up the build time since it had no impact on the actual reader experience and just slowed down my build and commit process. During this Thanksgiving break I finally decided to do something about it after discovering that jekyll has a profiling feature. It’s expected that the bulk of the time is spent generating the post pages but running the profiler highlighted that the majority of the work wasn’t in the actual content block but in generating the head element - something that shold similar from page to page.</p><table><thead><tr><th style=text-align:left>Filename</th><th style=text-align:left>Count</th><th style=text-align:left>Bytes</th><th style=text-align:left>Time</th></tr></thead><tbody><tr><td style=text-align:left>_layouts/default.html</td><td style=text-align:left>570</td><td style=text-align:left>16663.07K</td><td style=text-align:left>230.544</td></tr><tr><td style=text-align:left>_includes/themes/amp/default.html</td><td style=text-align:left>570</td><td style=text-align:left>16658.06K</td><td style=text-align:left>229.425</td></tr><tr><td style=text-align:left>_includes/head.html</td><td style=text-align:left>570</td><td style=text-align:left>11934.62K</td><td style=text-align:left>228.908</td></tr><tr><td style=text-align:left>_layouts/post.html</td><td style=text-align:left>562</td><td style=text-align:left>3595.71K</td><td style=text-align:left>5.542</td></tr><tr><td style=text-align:left>_includes/themes/amp/post.html</td><td style=text-align:left>562</td><td style=text-align:left>3590.77K</td><td style=text-align:left>4.640</td></tr><tr><td style=text-align:left>_includes/metadata.json</td><td style=text-align:left>570</td><td style=text-align:left>461.90K</td><td style=text-align:left>3.392</td></tr><tr><td style=text-align:left>_includes/setup</td><td style=text-align:left>2181</td><td style=text-align:left>14.91K</td><td style=text-align:left>2.345</td></tr><tr><td style=text-align:left>_includes/tags_list</td><td style=text-align:left>559</td><td style=text-align:left>73.99K</td><td style=text-align:left>0.874</td></tr><tr><td style=text-align:left>_includes/footer.html</td><td style=text-align:left>570</td><td style=text-align:left>1167.83K</td><td style=text-align:left>0.256</td></tr><tr><td style=text-align:left>sitemap.xml</td><td style=text-align:left>1</td><td style=text-align:left>62.20K</td><td style=text-align:left>0.245</td></tr><tr><td style=text-align:left>_includes/styles.scss</td><td style=text-align:left>570</td><td style=text-align:left>5736.18K</td><td style=text-align:left>0.115</td></tr><tr><td style=text-align:left>archive.html</td><td style=text-align:left>1</td><td style=text-align:left>120.81K</td><td style=text-align:left>0.114</td></tr><tr><td style=text-align:left>_includes/posts_collate</td><td style=text-align:left>1</td><td style=text-align:left>120.80K</td><td style=text-align:left>0.105</td></tr><tr><td style=text-align:left>atom.xml</td><td style=text-align:left>1</td><td style=text-align:left>1739.08K</td><td style=text-align:left>0.063</td></tr><tr><td style=text-align:left>tags.html</td><td style=text-align:left>1</td><td style=text-align:left>108.78K</td><td style=text-align:left>0.056</td></tr><tr><td style=text-align:left>_includes/header.html</td><td style=text-align:left>570</td><td style=text-align:left>709.16K</td><td style=text-align:left>0.056</td></tr><tr><td style=text-align:left>_includes/pages_list</td><td style=text-align:left>2</td><td style=text-align:left>103.64K</td><td style=text-align:left>0.047</td></tr><tr><td style=text-align:left>index.md</td><td style=text-align:left>1</td><td style=text-align:left>106.79K</td><td style=text-align:left>0.020</td></tr><tr><td style=text-align:left>_layouts/page.html</td><td style=text-align:left>6</td><td style=text-align:left>246.62K</td><td style=text-align:left>0.010</td></tr><tr><td style=text-align:left>sitemap.txt</td><td style=text-align:left>1</td><td style=text-align:left>34.99K</td><td style=text-align:left>0.010</td></tr><tr><td style=text-align:left>done in 245.117 seconds.</td><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left></td></tr></tbody></table><p>After taking a quick look at the head.html file it became clear what the problem was: AMP requires the CSS to be inline which combined with my usage of SCSS which needed to be transpiled to CSS on every page. Unsurprisingly, this was an expensive operation and the solution was to somehow get rid of it. While we can’t avoid inlining the CSS what we can do is transpile the SCSS to CSS once and include the contents in every post. Even better is to read the contents of the resulting CSS file once and then just inject it whenever necessary via the <a href=https://github.com/benbalter/jekyll-include-cache>jekyll-include-cache</a> extension. Applying these tactics gets the blog generation time down to 15 seconds from over 4 minutes. It does require the CSS file to be regenerated every time the SCSS file changes but given the infrequency it’s not a huge issue. This doesn’t make it any quicker to write posts but it does feel good to get such a big improvement in blog generation speed.</p><table><thead><tr><th style=text-align:left>Filename</th><th style=text-align:left>Count</th><th style=text-align:left>Bytes</th><th style=text-align:left>Time</th></tr></thead><tbody><tr><td style=text-align:left>_layouts/default.html</td><td style=text-align:left>570</td><td style=text-align:left>16663.10K</td><td style=text-align:left>4.277</td></tr><tr><td style=text-align:left>_layouts/post.html</td><td style=text-align:left>562</td><td style=text-align:left>3595.71K</td><td style=text-align:left>4.104</td></tr><tr><td style=text-align:left>_includes/themes/amp/default.html</td><td style=text-align:left>570</td><td style=text-align:left>16658.09K</td><td style=text-align:left>3.984</td></tr><tr><td style=text-align:left>_includes/head.html</td><td style=text-align:left>570</td><td style=text-align:left>11934.64K</td><td style=text-align:left>3.607</td></tr><tr><td style=text-align:left>_includes/themes/amp/post.html</td><td style=text-align:left>562</td><td style=text-align:left>3590.78K</td><td style=text-align:left>3.306</td></tr><tr><td style=text-align:left>_includes/metadata.json</td><td style=text-align:left>570</td><td style=text-align:left>461.92K</td><td style=text-align:left>2.420</td></tr><tr><td style=text-align:left>_includes/setup</td><td style=text-align:left>1612</td><td style=text-align:left>11.02K</td><td style=text-align:left>1.367</td></tr><tr><td style=text-align:left>_includes/tags_list</td><td style=text-align:left>559</td><td style=text-align:left>73.99K</td><td style=text-align:left>0.700</td></tr><tr><td style=text-align:left>sitemap.xml</td><td style=text-align:left>1</td><td style=text-align:left>62.20K</td><td style=text-align:left>0.251</td></tr><tr><td style=text-align:left>archive.html</td><td style=text-align:left>1</td><td style=text-align:left>120.81K</td><td style=text-align:left>0.119</td></tr><tr><td style=text-align:left>_includes/posts_collate</td><td style=text-align:left>1</td><td style=text-align:left>120.80K</td><td style=text-align:left>0.111</td></tr><tr><td style=text-align:left>atom.xml</td><td style=text-align:left>1</td><td style=text-align:left>1739.13K</td><td style=text-align:left>0.065</td></tr><tr><td style=text-align:left>tags.html</td><td style=text-align:left>1</td><td style=text-align:left>108.78K</td><td style=text-align:left>0.064</td></tr><tr><td style=text-align:left>_includes/pages_list</td><td style=text-align:left>2</td><td style=text-align:left>103.64K</td><td style=text-align:left>0.050</td></tr><tr><td style=text-align:left>_includes/header.html</td><td style=text-align:left>570</td><td style=text-align:left>709.16K</td><td style=text-align:left>0.041</td></tr><tr><td style=text-align:left>index.md</td><td style=text-align:left>1</td><td style=text-align:left>106.79K</td><td style=text-align:left>0.019</td></tr><tr><td style=text-align:left>sitemap.txt</td><td style=text-align:left>1</td><td style=text-align:left>34.99K</td><td style=text-align:left>0.011</td></tr><tr><td style=text-align:left>_layouts/page.html</td><td style=text-align:left>6</td><td style=text-align:left>246.62K</td><td style=text-align:left>0.008</td></tr><tr><td style=text-align:left>done in 15.077 seconds.</td><td style=text-align:left></td><td style=text-align:left></td><td style=text-align:left></td></tr></tbody></table></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2017/11/20/ride-sharing-ride-bailing/>« Ride sharing ride bailing</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2017/11/25/make-all-laws-temporary/>Make all laws temporary »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2024 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener("load",function(){hljs.initHighlighting()},!0)</script></body></html>