<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Security across multiple AWS regions - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="Amazon has a great concept with VPCs but unfortunately they don't work across regions. There's a simple workaround here that allows you to secure your cross region communication."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2017/05/04/security-across-multiple-aws-regions/"><meta property="og:title" content="Security across multiple AWS regions"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="Amazon has a great concept with VPCs but unfortunately they don't work across regions. There's a simple workaround here that allows you to secure your cross region communication."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Security across multiple AWS regions"><meta name=twitter:description content="Amazon has a great concept with VPCs but unfortunately they don't work across regions. There's a simple workaround here that allows you to secure your cross region communication."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2017/05/04/security-across-multiple-aws-regions/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=image/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Security across multiple AWS regions</h1><div class="mb-md-4 meta"><span class="date middot" title="Thu May 4 2017 00:00:00 UTC">2017-05-04</span>
<span class="reading-time middot">3 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/devops>devops</a></li><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>As great as AWS is there’s still a major gap in the way cross-region support are handled. It’s boggling that there’s no single screen to see every one of your instances and you’re forced to do it a region at a time. Beyond the cosmetic it’s not-obvious how to get instances from multiple regions to communicate securely with one another. On one hand Amazon has the neat concept of a Virtual Private Cloud (VPC) that allows you to create a group of machines that act as if they’re on the same network. This makes it simple come up with some pretty neat security rules - for example only allowing for an instance to communicate with the outside world via port 80 but with its network on other ports. Using a combination of VPCs and security groups one can come up with a pretty intricate security system.</p><p>Unfortunately this doesn’t work across regions. Instead, Amazon <a href=https://aws.amazon.com/answers/networking/aws-multiple-region-multi-vpc-connectivity/>suggests setting up a VPN</a> that can bridge the two networks. This makes sense if you have a dedicated DevOps team and the scale necessary to support this but I was looking for a much simpler solution. All I wanted was to have a few instances (powered by OpsWorks) that were scattered across the world be able to communicate securely with the primary system that was hosted in the US East region. After a minor back and forth with the AWS support team we were able to come up with the following, somewhat elegant, solution. Note that I contributed minimally here and almost all the credit should go to AWS support.</p><p>The solution was to update the setup recipe of our instances outside the US East region to whitelist themselves on the relevant security group (code below). In theory it’s simple but there were a few small gotchas that needed to be handled:</p><ul><li>Deregistration. Since there’s a maximum number of rules that a security group may have it’s important to also add a shutdown recipe that removes the instance from the security group.</li><li>Permissions. It turns out that every instance that starts up within OpsWorks has an IAM role which needs to be updated to support the AuthorizeSecurityGroupIngress and RevokeSecurityGroupIngress actions.</li><li>Stack settings. While possible to hardcode the relevant ids and values into the OpsWorks recipe it makes a lot more sense to make this dynamic and driven by the Stack settings.</li></ul><p>I wish Amazon supported VPCs that could span multiple regions but it turned out that this workaround wasn’t as difficult as I thought. There’s still the risk that this approach will fail when we hit the security group rule limit or the API calls fail but by then I’m hopeful there’s a legitimate solution.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#75715e># Authorize</span>
require <span style=color:#e6db74>&#39;aws-sdk&#39;</span>
ec2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>AWS</span><span style=color:#f92672>::</span><span style=color:#66d9ef>EC2</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Client</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>region</span>: <span style=color:#e6db74>&#39;us-east-1&#39;</span>)
resp <span style=color:#f92672>=</span> ec2<span style=color:#f92672>.</span>authorize_security_group_ingress({
  <span style=color:#e6db74>group_id</span>: <span style=color:#e6db74>&#39;sg-####&#39;</span>,
  <span style=color:#e6db74>ip_permissions</span>: <span style=color:#f92672>[</span>
    {
      <span style=color:#e6db74>ip_protocol</span>: <span style=color:#e6db74>&#34;tcp&#34;</span>,
      <span style=color:#e6db74>from_port</span>: <span style=color:#ae81ff>443</span>,
      <span style=color:#e6db74>to_port</span>: <span style=color:#ae81ff>443</span>,
      <span style=color:#e6db74>ip_ranges</span>: <span style=color:#f92672>[</span>
        {
          <span style=color:#e6db74>cidr_ip</span>: <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>node<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;opsworks&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;instance&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ip&#34;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/32&#34;</span>,
        },
      <span style=color:#f92672>]</span>,
    },
  <span style=color:#f92672>]</span>,
})

<span style=color:#75715e># Revoke</span>
require <span style=color:#e6db74>&#39;aws-sdk&#39;</span>
ec2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>AWS</span><span style=color:#f92672>::</span><span style=color:#66d9ef>EC2</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Client</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>region</span>: <span style=color:#e6db74>&#39;us-east-1&#39;</span>)
resp <span style=color:#f92672>=</span> ec2<span style=color:#f92672>.</span>revoke_security_group_ingress({
  <span style=color:#e6db74>group_id</span>: <span style=color:#e6db74>&#39;sg-####&#39;</span>,
  <span style=color:#e6db74>ip_permissions</span>: <span style=color:#f92672>[</span>
    {
      <span style=color:#e6db74>ip_protocol</span>: <span style=color:#e6db74>&#34;tcp&#34;</span>,
      <span style=color:#e6db74>from_port</span>: <span style=color:#ae81ff>443</span>,
      <span style=color:#e6db74>to_port</span>: <span style=color:#ae81ff>443</span>,
      <span style=color:#e6db74>ip_ranges</span>: <span style=color:#f92672>[</span>
        {
          <span style=color:#e6db74>cidr_ip</span>: <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>#{</span>node<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;opsworks&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;instance&#34;</span><span style=color:#f92672>][</span><span style=color:#e6db74>&#34;ip&#34;</span><span style=color:#f92672>]</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/32&#34;</span>,
        },
      <span style=color:#f92672>]</span>,
    },
  <span style=color:#f92672>]</span>,
})</code></pre></div></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2017/04/30/having-some-fun-with-the-rgb-color-model/>« Having some fun with the RGB color model</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2017/05/07/tools-over-languages/>Tools over languages »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script></body></html>