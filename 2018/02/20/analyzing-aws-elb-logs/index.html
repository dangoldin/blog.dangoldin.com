<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Analyzing AWS ELB logs - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="You can get a ton of useful information about your web application by loading the ELB logs into Redshift and running some queries."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2018/02/20/analyzing-aws-elb-logs/"><meta property="og:title" content="Analyzing AWS ELB logs"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="You can get a ton of useful information about your web application by loading the ELB logs into Redshift and running some queries."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Analyzing AWS ELB logs"><meta name=twitter:description content="You can get a ton of useful information about your web application by loading the ELB logs into Redshift and running some queries."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2018/02/20/analyzing-aws-elb-logs/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-36313127-1');</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Analyzing AWS ELB logs</h1><div class="mb-md-4 meta"><span class="date middot" title="Tue Feb 20 2018 00:00:00 UTC">2018-02-20</span>
<span class="reading-time middot">3 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li><li class="d-inline middot"><a href=/tags/sql>sql</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>Logging HTTP requests should be enabled for every application you run. When things go wrong, and they will, it’s often the first step to understand the problem. Unfortunately, logging isn’t always top of mind and is often forgotten. Luckily, if you use the Elastic Load Balancer (ELB) functionality within AWS you’re able to set up ELB logs that track every request and write it to an S3 bucket. The documentation is up on the <a href=https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/access-log-collection.html>Amazon site</a> but there’s a surprising amount of information that’s hidden away in the logs. Since it’s Amazon and they want to make it as easy for you to use their various services together it’s simple to load the logs into Redshift and start digging into them via some basic queries.</p><p>I wanted to highlight a few I used in the past couple of weeks to dig into an issue. Despite having a centralized logging system I still find it easier to just write SQL queries - it’s significantly more expressive than any log exploration tool I’ve used and allows me to exactly what I without any magic.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- Load the data into Redshift
</span><span style=color:#75715e></span><span style=color:#66d9ef>copy</span> elb_logs
<span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;s3://logdirs/.../us-east-1/2018/02/19/&#39;</span>
COMPUPDATE <span style=color:#66d9ef>OFF</span> CREDENTIALS <span style=color:#e6db74>&#39;aws_access_key_id=KEY;aws_secret_access_key=SECRET&#39;</span>
<span style=color:#66d9ef>delimiter</span> <span style=color:#e6db74>&#39; &#39;</span>
TIMEFORMAT <span style=color:#66d9ef>as</span> <span style=color:#e6db74>&#39;auto&#39;</span>
ACCEPTINVCHARS
REMOVEQUOTES
FILLRECORD
MAXERROR <span style=color:#66d9ef>as</span> <span style=color:#ae81ff>100000</span>;

<span style=color:#75715e>-- Look at the distribution of ELB status codes
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> elbresponsecode, <span style=color:#66d9ef>count</span>(<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> cnt
<span style=color:#66d9ef>from</span> elb_logs
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> elbresponsecode
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> elbresponsecode;

<span style=color:#75715e>-- Look at the distribution of backend status codes
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> backendresponsecode, <span style=color:#66d9ef>count</span>(<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> cnt
<span style=color:#66d9ef>from</span> elb_logs
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> backendresponsecode
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> backendresponsecode;

<span style=color:#75715e>-- Look at distribution by both
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> elbresponsecode, backendresponsecode, <span style=color:#66d9ef>count</span>(<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> cnt
<span style=color:#66d9ef>from</span> elb_logs
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> elbresponsecode, backendresponsecode
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> elbresponsecode;

<span style=color:#75715e>-- Look at distribution by both where they&#39;re unequal
</span><span style=color:#75715e>-- This highlights cases where the ELB was unable to reach the hosts
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> elbresponsecode, backendresponsecode, <span style=color:#66d9ef>count</span>(<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> cnt
<span style=color:#66d9ef>from</span> elb_logs
<span style=color:#66d9ef>where</span> elbresponsecode <span style=color:#f92672>!=</span> backendresponsecode
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> elbresponsecode, backendresponsecode
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> elbresponsecode;

<span style=color:#75715e>-- A simple way to look at the request groups causing problems
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> split_part(httprequest, <span style=color:#e6db74>&#39;?&#39;</span>, <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> httprequestbase, <span style=color:#66d9ef>count</span>(<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> cnt
<span style=color:#66d9ef>from</span> elb_logs
<span style=color:#66d9ef>where</span> elbresponsecode <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>500</span>
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> httprequestbase
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> cnt <span style=color:#66d9ef>desc</span>;

<span style=color:#75715e>-- For fun, we can also look at the number of errors by minute to see if we can spot a pattern
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> to_char(requesttime, <span style=color:#e6db74>&#39;YYYY-MM-DD HH24:MI&#39;</span>) <span style=color:#66d9ef>as</span> datetime,
  <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> elbresponsecode <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span>) <span style=color:#66d9ef>as</span> n500,
  <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> elbresponsecode <span style=color:#f92672>=</span> <span style=color:#ae81ff>501</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span>) <span style=color:#66d9ef>as</span> n501,
  <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> elbresponsecode <span style=color:#f92672>=</span> <span style=color:#ae81ff>502</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span>) <span style=color:#66d9ef>as</span> n502,
  <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> elbresponsecode <span style=color:#f92672>=</span> <span style=color:#ae81ff>503</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span>) <span style=color:#66d9ef>as</span> n503,
  <span style=color:#66d9ef>sum</span>(<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>when</span> elbresponsecode <span style=color:#f92672>=</span> <span style=color:#ae81ff>504</span> <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>else</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>end</span>) <span style=color:#66d9ef>as</span> n504
<span style=color:#66d9ef>from</span> elb_logs
<span style=color:#66d9ef>where</span> elbresponsecode <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>500</span>
<span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> datetime
<span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> datetime;
<span style=color:#960050;background-color:#1e0010>{</span><span style=color:#f92672>%</span> endhighlight <span style=color:#66d9ef>sql</span> <span style=color:#f92672>%</span><span style=color:#960050;background-color:#1e0010>}</span></code></pre></div></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2018/02/10/optimize-for-keyboard-shortcuts/>« Optimize for keyboard shortcuts</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2018/02/25/retrieving-kindle-highlights/>Retrieving Kindle highlights »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script></body></html>