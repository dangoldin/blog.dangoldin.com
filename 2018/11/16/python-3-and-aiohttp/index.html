<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Python 3 and aiohttp - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="I finally got the chance to mess aroun with Python 3's async functionality and had fun using the aiohttp library."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2018/11/16/python-3-and-aiohttp/"><meta property="og:title" content="Python 3 and aiohttp"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="I finally got the chance to mess aroun with Python 3's async functionality and had fun using the aiohttp library."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Python 3 and aiohttp"><meta name=twitter:description content="I finally got the chance to mess aroun with Python 3's async functionality and had fun using the aiohttp library."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2018/11/16/python-3-and-aiohttp/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/image/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-36313127-1');</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Python 3 and aiohttp</h1><div class="mb-md-4 meta"><span class="date middot" title="Fri Nov 16 2018 00:00:00 UTC">2018-11-16</span>
<span class="reading-time middot">2 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>A few months back I read about <a href=https://aiohttp.readthedocs.io/en/stable/>aiohttp</a> and asyncio and finally got the chance to play around with it a few weeks back. The project was a quick one-off scrape of a few thousand domains to see what percentage had implemented the <a href=https://github.com/InteractiveAdvertisingBureau/GDPR-Transparency-and-Consent-Framework/blob/master/pubvendors.json%20v1.0%20Draft%20for%20Public%20Comment.md>pubvendors.json</a> spec, an extension of GDPR that allows publishers to specify the vendors they’re working with.</p><p>My initial reaction was to do it in the way I’ve done it countless times before: the requests library in a for loop. Instead I decided to actually try something new and use the aiohttp library, a new asynchronous library for Python 3. It took me a little bit of time to figure out how to structure the code and use Python’s new async functionality (which by the way is very similar to modern JavaScript) but the end result is simple for what it does and runs incredibly quickly.</p><p>The code below is my attempt at a functional solution - it’s inspired by imitating the aiohttp examples as well as a few helpful blog posts. I’m sure it’s far from perfect and I don’t do much other than print the status but it got me what I needed. If you’re doing any sort of scraping or network heavy work take the time to learn the new async functionality provided in Python 3 - it’s a massive performance improvement.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#! /usr/bin/env python</span>

<span style=color:#f92672>import</span> aiohttp
<span style=color:#f92672>import</span> asyncio
<span style=color:#f92672>import</span> json

timeout <span style=color:#f92672>=</span> aiohttp<span style=color:#f92672>.</span>ClientTimeout(total<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)

URLS <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example1.com example2.com example3.com&#34;</span><span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34; &#34;</span>)

async <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fetch</span>(session, url):
    <span style=color:#66d9ef>try</span>:
        async <span style=color:#66d9ef>with</span> session<span style=color:#f92672>.</span>get(url) <span style=color:#66d9ef>as</span> response:
            data <span style=color:#f92672>=</span> await response<span style=color:#f92672>.</span>text()
            valid_pv <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;{&#39;</span>)
            <span style=color:#66d9ef>print</span>(url, valid_pv)
            <span style=color:#66d9ef>return</span> valid_pv
    <span style=color:#66d9ef>except</span>:
        <span style=color:#66d9ef>print</span>(url, <span style=color:#e6db74>&#39;Error&#39;</span>)
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Error&#39;</span>

async <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bound_fetch</span>(sem, session, url):
    async <span style=color:#66d9ef>with</span> sem:
        await fetch(url, session)

async <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(urls):
    tasks <span style=color:#f92672>=</span> []
    sem <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>Semaphore(<span style=color:#ae81ff>100</span>)

    async <span style=color:#66d9ef>with</span> aiohttp<span style=color:#f92672>.</span>ClientSession() <span style=color:#66d9ef>as</span> session:
        <span style=color:#66d9ef>for</span> url <span style=color:#f92672>in</span> urls:
            <span style=color:#75715e># Blame the spec for the path, don&#39;t worry about HTTPS for now</span>
            full_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;http://&#39;</span> <span style=color:#f92672>+</span> url <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/.well-known/pubvendors.json&#39;</span>
            task <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>ensure_future(bound_fetch(sem, full_url, session))
            tasks<span style=color:#f92672>.</span>append(task)

        responses <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>gather(<span style=color:#f92672>*</span>tasks)
        await responses

URLS <span style=color:#f92672>=</span> [url<span style=color:#f92672>.</span>lower() <span style=color:#66d9ef>for</span> url <span style=color:#f92672>in</span> URLS <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> url<span style=color:#f92672>.</span>lower()<span style=color:#f92672>.</span>endswith(<span style=color:#e6db74>&#39;.app&#39;</span>)]

<span style=color:#66d9ef>print</span>(URLS)

loop <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>get_event_loop()
future <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>ensure_future(run(URLS))
loop<span style=color:#f92672>.</span>run_until_complete(future)
{<span style=color:#f92672>%</span> endhighlight python <span style=color:#f92672>%</span>}</code></pre></div></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2018/11/15/limiting-tracking-in-email/>« Limiting tracking in email</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2018/11/17/random-quotes/>Random quotes »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script></body></html>