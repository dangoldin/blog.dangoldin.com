<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>MySQL foreign keys - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="MySQL foreign keys are a great way to enforce consistency in your database but it's not always obvious how they work. I provide examples for each option and its impact."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2018/07/07/mysql-foreign-keys/"><meta property="og:title" content="MySQL foreign keys"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="MySQL foreign keys are a great way to enforce consistency in your database but it's not always obvious how they work. I provide examples for each option and its impact."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="MySQL foreign keys"><meta name=twitter:description content="MySQL foreign keys are a great way to enforce consistency in your database but it's not always obvious how they work. I provide examples for each option and its impact."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2018/07/07/mysql-foreign-keys/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36313127-1')</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">MySQL foreign keys</h1><div class="mb-md-4 meta"><span class="date middot" title="Sat Jul 7 2018 00:00:00 UTC">2018-07-07</span>
<span class="reading-time middot">4 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>Databases are the last layer of defense against corrupt data and the more restrictive you can make them the better. No matter how much validation you may have missed in your code having a strong and restrictive database schema will protect your data. One of the best approaches to building a restrictive schema is using foreign keys which specify how fields from one table relate to the fields of another table. There are a few options here and make it possible for you to specify anything from automatically removing rows when a row they’re referencing is removed to recursively updating rows when their references have changed.</p><p>The <a href=https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html>MySQL docs</a> give a nice overview of how foreign keys work but they’re light on examples and since I tend to learn best from examples I wanted to share them along with a brief description. Hopefully others find these examples useful as well. Each of the examples creates two tables, test_parent and test_child, with test_child having a different foreign key option on a field referencing the test_parent. I also insert the same data into each one to start and then do a few follow up queries describing what happens in each scenario. Also note that there is both an &ldquo;ON DELETE&rdquo; and an &ldquo;ON UPDATE&rdquo; option which, as expected, controls the respective behaviors.</p><h3 id=restrict>RESTRICT</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> test_child;
<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> test_parent;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_parent (
    id INT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id)
) ENGINE<span style=color:#f92672>=</span>INNODB;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_child (
    id INT,
    parent_id INT,
    <span style=color:#66d9ef>INDEX</span> par_ind (parent_id),
    <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (parent_id) <span style=color:#66d9ef>REFERENCES</span> test_parent(id)
        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>RESTRICT</span>
        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>RESTRICT</span>
) ENGINE<span style=color:#f92672>=</span>INNODB;

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test_parent (id) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test_child (id, parent_id) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>);

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_child;
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_parent;

<span style=color:#75715e>-- This fails since one of test_child rows referneces this row.
</span><span style=color:#75715e></span><span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>from</span> test_parent <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#75715e>-- By deleting the associated test_child row first we&#39;ll be able to delete the row in test_parent.
</span><span style=color:#75715e></span><span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>from</span> test_child <span style=color:#66d9ef>where</span> parent_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#75715e>-- Now that there&#39;s no test_child row referencing this we&#39;re able to delete successfully.
</span><span style=color:#75715e></span><span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>from</span> test_parent <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#75715e>-- Similarly, we can&#39;t update the key since it&#39;s being referenced by one of the child rows.
</span><span style=color:#75715e></span><span style=color:#66d9ef>update</span> test_parent <span style=color:#66d9ef>set</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;</code></pre></div><h3 id=cascade>CASCADE</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> test_child;
<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> test_parent;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_parent (
    id INT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id)
) ENGINE<span style=color:#f92672>=</span>INNODB;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_child (
    id INT,
    parent_id INT,
    <span style=color:#66d9ef>INDEX</span> par_ind (parent_id),
    <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (parent_id) <span style=color:#66d9ef>REFERENCES</span> test_parent(id)
        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>CASCADE</span>
        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>CASCADE</span>
) ENGINE<span style=color:#f92672>=</span>INNODB;

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test_parent (id) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test_child (id, parent_id) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>);

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_child;
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_parent;

<span style=color:#75715e>-- This removes both the row in test_parent as well as the associated row in test_child.
</span><span style=color:#75715e></span><span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>from</span> test_parent <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#75715e>-- This updates both the row in test_parents as well as the referenced field in test_child.
</span><span style=color:#75715e></span><span style=color:#66d9ef>update</span> test_parent <span style=color:#66d9ef>set</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;</code></pre></div><h3 id=set-null>SET NULL</h3><p>Note that in this case we can&rsquo;t even make parent_id NOT NULL in the test_child table create - MySQL rejects that statement.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> test_child;
<span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>EXISTS</span> test_parent;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_parent (
    id INT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (id)
) ENGINE<span style=color:#f92672>=</span>INNODB;

<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> test_child (
    id INT,
    parent_id INT,
    <span style=color:#66d9ef>INDEX</span> par_ind (parent_id),
    <span style=color:#66d9ef>FOREIGN</span> <span style=color:#66d9ef>KEY</span> (parent_id) <span style=color:#66d9ef>REFERENCES</span> test_parent(id)
        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NULL</span>
        <span style=color:#66d9ef>ON</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>SET</span> <span style=color:#66d9ef>NULL</span>
) ENGINE<span style=color:#f92672>=</span>INNODB;

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test_parent (id) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test_child (id, parent_id) <span style=color:#66d9ef>VALUES</span> (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>), (<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>), (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>), (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>);

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_parent;
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_child;

<span style=color:#75715e>-- This deletes the row in test_parent and also makes the parent_id value for the associated row in test_child null.
</span><span style=color:#75715e></span><span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>from</span> test_parent <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_child;

<span style=color:#75715e>-- Similarly, the parent_id field in test_child that used to be 2 is now null.
</span><span style=color:#75715e></span><span style=color:#66d9ef>update</span> test_parent <span style=color:#66d9ef>set</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>where</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> test_child;</code></pre></div><h3 id=no-action>NO ACTION</h3><p>No example here since in MySQL this works exactly the same as the RESTRICT option above.</p><h3 id=set-default>SET DEFAULT</h3><p>This is not a valid option in MySQL using the INNODB engine.</p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2018/06/28/using-personal-aws-credentials-in-production/>« Using personal AWS credentials in production</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2018/07/10/in-a-software-world-humanity-comes-first/>In a software world, humanity comes first »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting()},!0)</script></body></html>