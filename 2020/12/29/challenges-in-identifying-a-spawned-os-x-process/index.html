<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Challenges in identifying a spawned OS X process - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="While working on a simple proof of concept to show images I ran into some challenges identifying a spawned process in OS X and came up with a hack to get around them."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2020/12/29/challenges-in-identifying-a-spawned-os-x-process/"><meta property="og:title" content="Challenges in identifying a spawned OS X process"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="While working on a simple proof of concept to show images I ran into some challenges identifying a spawned process in OS X and came up with a hack to get around them."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Challenges in identifying a spawned OS X process"><meta name=twitter:description content="While working on a simple proof of concept to show images I ran into some challenges identifying a spawned process in OS X and came up with a hack to get around them."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2020/12/29/challenges-in-identifying-a-spawned-os-x-process/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/image/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-36313127-1');</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Challenges in identifying a spawned OS X process</h1><div class="mb-md-4 meta"><span class="date middot" title="Tue Dec 29 2020 00:00:00 UTC">2020-12-29</span>
<span class="reading-time middot">4 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>As part of my project to come up with a utility to deduplicate images on S3 I started working on a proof of concept to validate the flow and functionality. I know that the AWS S3 API has everything I need but I wanted to see whether I could use the built in OS tools to handle the image comparison without resorting to a webapp. The steps I had in mind were pretty simple:</p><ol><li>Use the AWS S3 API to fetch a list of all file paths and sizes</li><li>Identify potential duplicates by looking at matches between extensions and sizes</li><li>Display the potential duplicates and have the user pick the desired action - keep one, both, or neither.</li></ol><p>I know that I could do 1 and 2 easily but I was curious how well I could accomplish 3 which turned out to be surprisingly tricky and even now I&rsquo;m not too happy with the solution I hacked together.</p><p>To start, I just downloaded two images as a starting point and used Python&rsquo;s subprocess module to open them up in the default application - which on OS X was Preview. That part worked well but what was difficult was automatically closing the Preview application. The reason is that &ldquo;open&rdquo; does not actually open the files but instead offloads that to OS X which then opens the Preview application. I had the idea that my script would be the parent process of Preview but there didn&rsquo;t seem an obvious way to link the two.</p><p>After a bit of research my first attempt was to just derive the process ids. The idea here is that I can get a process id for each of the times I call subprocess.Popen and then increment it in order to get the process id for the Preview application. It worked reasonably well but I ran into cases where there were other system processes launching during execution and I didn&rsquo;t want to make any assumptions - especially if someone has other default applications. This led me to do a fair amount of documentation reading - both of the <a href=https://docs.python.org/3/library/subprocess.html>subprocess</a> module as well as the <a href=https://psutil.readthedocs.io/en/latest/>psutil</a> library - but neither gave me what I needed.</p><p>In essence, I needed to identify the processes that were started as a function of my script but wasn&rsquo;t able to figure this out using the functionality available in the processes themselves. I don&rsquo;t know if this is due to some security restrictions or solely a problem in OS X but even looking at Activity Monitor it didn&rsquo;t seem there was any connection between Preview and the Python script.</p><p>But looking at Activity Monitor gave me the idea to leverage knowledge of the open files. Since I know the names of the files I can find out which process has them open and then kill that process. This turned out to be exactly what I needed to get the proof of concept working but there are a few gotchas. One is that if the Preview application has already been opened to look at other files do I really want to be killing it? The other is that I don&rsquo;t control the layout so the images that are automatically opened may be stacked which ruins the experience.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#! /usr/bin/env python</span>

<span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> subprocess
<span style=color:#f92672>import</span> time
<span style=color:#f92672>import</span> signal
<span style=color:#f92672>import</span> psutil

<span style=color:#75715e># Keep existing set so we don&#39;t kill application if it&#39;s already open</span>
existing_pids <span style=color:#f92672>=</span> set(psutil<span style=color:#f92672>.</span>pids())

fn1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;UNADJUSTEDNONRAW_mini_742.jpg&#39;</span>
fn2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;UNADJUSTEDNONRAW_mini_866.jpg&#39;</span>

viewer <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>Popen([<span style=color:#e6db74>&#39;open&#39;</span>, <span style=color:#e6db74>&#39;-W&#39;</span>, fn1])
viewer2 <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>Popen([<span style=color:#e6db74>&#39;open&#39;</span>, <span style=color:#e6db74>&#39;-W&#39;</span>, fn2])

time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>2</span>)

pids_to_kill <span style=color:#f92672>=</span> set()
<span style=color:#66d9ef>for</span> filename <span style=color:#f92672>in</span> [fn1, fn2]:
    pids <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>check_output([<span style=color:#e6db74>&#39;fuser&#39;</span>, <span style=color:#e6db74>&#39;--&#39;</span>, filename])
    <span style=color:#66d9ef>for</span> pid <span style=color:#f92672>in</span> map(int, pids<span style=color:#f92672>.</span>split()):
        pids_to_kill<span style=color:#f92672>.</span>add(pid)

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;pids to kill&#34;</span>, pids_to_kill)

<span style=color:#66d9ef>for</span> pid <span style=color:#f92672>in</span> pids_to_kill:
    <span style=color:#66d9ef>if</span> pid <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> existing_pids:
        os<span style=color:#f92672>.</span>killpg(pid, signal<span style=color:#f92672>.</span>SIGUSR1)</code></pre></div><p>While working on the script gave me a better understanding of the way processes work in OS X and the tools available my desire to avoid a webapp may have been for naught. It&rsquo;s likely simpler, faster, and a better experience to just build a simple webapp.</p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2020/12/29/improving-the-accuracy-of-evergreen-content/>« Improving the accuracy of evergreen content</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2020/12/29/2021-goals/>2021 goals »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script></body></html>