<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Adding attachments to django-postman - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="We built a small app that let us add attachments to django-postman by leveraging the the jquery-file-upload library."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2013/05/17/adding-attachments-to-django-postman/"><meta property="og:title" content="Adding attachments to django-postman"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="We built a small app that let us add attachments to django-postman by leveraging the the jquery-file-upload library."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Adding attachments to django-postman"><meta name=twitter:description content="We built a small app that let us add attachments to django-postman by leveraging the the jquery-file-upload library."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2013/05/17/adding-attachments-to-django-postman/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/image/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-36313127-1');</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Adding attachments to django-postman</h1><div class="mb-md-4 meta"><span class="date middot" title="Fri May 17 2013 00:00:00 UTC">2013-05-17</span>
<span class="reading-time middot">4 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/python>python</a></li><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>After doing a round of customer development for <a href=https://makersalley.com/ target=_blank>Makers Alley</a>, we discovered that customers really wanted to communicate with makers about their pieces. In true MVP fashion, we got the first iteration out in a day by using <a href=https://bitbucket.org/psam/django-postman/overview target=_blank>django-postman</a> to handle the user to user communication. Within a few days, we quickly discovered that text messages weren&rsquo;t enough and we needed to support file attachments, otherwise makers can’t easily show their designs and customers can’t share what they like. Unfortunately, django-postman does not support attachments and we didn’t want to have to incorporate another messaging library. Another constraint was that we were already using the awesome <a href=http://blueimp.github.io/jQuery-File-Upload/ target=_blank>jQuery File Upload</a> library (in truth, a modified <a href=https://github.com/sigurdga/django-jquery-file-upload target=_blank>Django version by Sigurd Gartmann</a>) to allow makers to upload images when managing their storefronts.</p><p>We wanted to leverage our existing file upload system but also incorporate it with the django-postman messaging library without having to modify any of the code in django-postman. We weren’t able to find <a href=http://stackoverflow.com/questions/16570019/how-can-i-modify-django-postman-to-allow-sending-of-attachments/ target=_blank>anything on StackOverflow</a> that dealt with this issue so we were left with writing our own. Here’s the approach we ended up taking that might come in handy for anyone else running into the same problem. The code needs some cleaning and I need to add some error checking but I’m sharing it with the excuse of “perfect is the enemy of good.”</p><p>We built a new app, postman_attachments, that would serve as the intermediary between the file upload piece and django-postman.</p><ul><li>models.py: Attachment that would map the django-postman Message model to an uploaded file<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Attachment</span>(models<span style=color:#f92672>.</span>Model):
    message <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(postman_models<span style=color:#f92672>.</span>Message)
    attachment <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(fileupload_models<span style=color:#f92672>.</span>GenericFile)

    <span style=color:#66d9ef>def</span> __unicode__(self):
        <span style=color:#66d9ef>return</span> str(self<span style=color:#f92672>.</span>message) <span style=color:#f92672>+</span> self<span style=color:#f92672>.</span>attachment<span style=color:#f92672>.</span>__unicode__()</code></pre></div></li><li>api.py: Versions of pm_write and pm_broadcast that would do the same work as the original but would also map the attachments between<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pma_write</span>(sender, recipient, subject, file_ids<span style=color:#f92672>=</span>[], body<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>, skip_notification<span style=color:#f92672>=</span>False,
        auto_archive<span style=color:#f92672>=</span>False, auto_delete<span style=color:#f92672>=</span>False, auto_moderators<span style=color:#f92672>=</span>None):

        <span style=color:#75715e>### Same code as in pm_write</span>

        <span style=color:#66d9ef>for</span> file_id <span style=color:#f92672>in</span> file_ids:
            f <span style=color:#f92672>=</span> GenericFile<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(id<span style=color:#f92672>=</span>file_id)
            a <span style=color:#f92672>=</span> Attachment(message<span style=color:#f92672>=</span>message,attachment<span style=color:#f92672>=</span>f)
            a<span style=color:#f92672>.</span>save()</code></pre></div></li><li>forms.py: In our case, we needed to tweak the FullReplyForm and created our own version that included a new “file_ids” field to hold the ids of the uploaded files. The full solution would need to make versions of the other forms included in django-postman.<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>allow_copies <span style=color:#f92672>=</span> <span style=color:#f92672>not</span> getattr(settings, <span style=color:#e6db74>&#39;POSTMAN_DISALLOW_COPIES_ON_REPLY&#39;</span>, False)
<span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FullReplyImageForm</span>(BaseReplyForm):
    <span style=color:#e6db74>&#34;&#34;&#34;The complete reply form.&#34;&#34;&#34;</span>
    <span style=color:#66d9ef>if</span> allow_copies:
        recipients <span style=color:#f92672>=</span> CommaSeparatedUserField(label<span style=color:#f92672>=</span>(_(<span style=color:#e6db74>&#34;Additional recipients&#34;</span>), _(<span style=color:#e6db74>&#34;Additional recipient&#34;</span>)), required<span style=color:#f92672>=</span>False)

    file_ids <span style=color:#f92672>=</span> forms<span style=color:#f92672>.</span>CharField(required<span style=color:#f92672>=</span>False,widget<span style=color:#f92672>=</span>forms<span style=color:#f92672>.</span>HiddenInput())

    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>(BaseReplyForm<span style=color:#f92672>.</span>Meta):
        fields <span style=color:#f92672>=</span> ([<span style=color:#e6db74>&#39;recipients&#39;</span>] <span style=color:#66d9ef>if</span> allow_copies <span style=color:#66d9ef>else</span> []) <span style=color:#f92672>+</span> [<span style=color:#e6db74>&#39;subject&#39;</span>, <span style=color:#e6db74>&#39;body&#39;</span>, <span style=color:#e6db74>&#39;file_ids&#39;</span>]

    <span style=color:#a6e22e>@transaction.commit_on_success</span>
    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>save</span>(self, recipient<span style=color:#f92672>=</span>None, parent<span style=color:#f92672>=</span>None, auto_moderators<span style=color:#f92672>=</span>[]):
        <span style=color:#75715e>### Bunch of code from original save method in BaseWriteForm from django-postman</span>
        file_ids <span style=color:#f92672>=</span> [x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>cleaned_data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;file_ids&#39;</span>)<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;,&#39;</span>) <span style=color:#66d9ef>if</span> x]
        <span style=color:#75715e>### Bunch of code from original save method in BaseWriteForm from django-postman</span>
        <span style=color:#66d9ef>for</span> file_id <span style=color:#f92672>in</span> file_ids:
            f <span style=color:#f92672>=</span> GenericFile<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(id<span style=color:#f92672>=</span>file_id)
            a <span style=color:#f92672>=</span> Attachment(message<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>instance,attachment<span style=color:#f92672>=</span>f)
            a<span style=color:#f92672>.</span>save()</code></pre></div></li></ul><p>In addition, we needed to override the default django-postman templates to display the attachments for a message as well as include the necessary javascript to deal with the jQuery File Upload piece.</p><ul><li>view.html<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>{% raw %}
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pm_body&#34;</span>&gt;{{ message.body|linebreaksbr }}&lt;/<span style=color:#f92672>div</span>&gt;
      {% if message.attachment_set.all %}
        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;pm_attachments&#34;</span>&gt;
          &lt;<span style=color:#f92672>span</span>&gt;Attachments&lt;/<span style=color:#f92672>span</span>&gt;
          &lt;<span style=color:#f92672>ul</span>&gt;
            {% for a in message.attachment_set.all %}
              &lt;<span style=color:#f92672>li</span>&gt;&lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ a.attachment.file.url }}&#34;</span> <span style=color:#a6e22e>target</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;_blank&#34;</span>&gt;{{ a.attachment.file.url }}&lt;/<span style=color:#f92672>a</span>&gt;&lt;/<span style=color:#f92672>li</span>&gt;
            {% endfor %}
          &lt;/<span style=color:#f92672>ul</span>&gt;
        &lt;/<span style=color:#f92672>div</span>&gt;
      {% endif %}{% endraw %}</code></pre></div></li><pre><code>&lt;li&gt;view.js
    <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>$</span>(document).<span style=color:#a6e22e>ready</span>(<span style=color:#66d9ef>function</span>(){
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>upload_ids</span> <span style=color:#f92672>=</span> [];
  <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#fileupload-attachments&#39;</span>).<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#39;fileuploaddone&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>data</span>) {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Done uploading product images&#39;</span>);
    <span style=color:#a6e22e>$</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>result</span>).<span style=color:#a6e22e>each</span>(<span style=color:#66d9ef>function</span>(){
      <span style=color:#a6e22e>upload_ids</span>.<span style=color:#a6e22e>push</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>id</span>);
    });
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>( <span style=color:#a6e22e>upload_ids</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>) );
    <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#id_file_ids&#39;</span>).<span style=color:#a6e22e>val</span>( <span style=color:#a6e22e>upload_ids</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>) );

    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#fileupload-attachments td.preview&#39;</span>).<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>upload_ids</span>.<span style=color:#a6e22e>length</span>) {
      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Enabling input&#39;</span>);
      <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#reply-form button[type=&#34;submit&#34;]&#39;</span>).<span style=color:#a6e22e>removeAttr</span>(<span style=color:#e6db74>&#39;disabled&#39;</span>);
    };
  });

  <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#fileupload-attachments&#39;</span>).<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#39;fileuploadstart&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>data</span>) {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Disabling input&#39;</span>);
    <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#reply-form button[type=&#34;submit&#34;]&#39;</span>).<span style=color:#a6e22e>attr</span>(<span style=color:#e6db74>&#39;disabled&#39;</span>,<span style=color:#e6db74>&#39;disabled&#39;</span>);
  });

  <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#fileupload-attachments&#39;</span>).<span style=color:#a6e22e>bind</span>(<span style=color:#e6db74>&#39;fileuploadpreviewdone&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>data</span>) {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#fileupload-attachments td.preview&#39;</span>).<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>product_image_ids</span>.<span style=color:#a6e22e>length</span>) {
      <span style=color:#a6e22e>$</span>(<span style=color:#e6db74>&#39;#fileupload-attachments tbody.files tr&#39;</span>).<span style=color:#a6e22e>remove</span>();
    };
  });
});
</code></pre></div>&lt;/li></code></pre></ul><p>The last minor thing we needed to do was update our urls.py file to override the standard django-postman urls to have them use our custom form.</p><ul><li>urls.py<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>url(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;^messages/reply/(?P&lt;message_id&gt;[\d]+)/$&#39;</span>, <span style=color:#e6db74>&#39;postman.views.reply&#39;</span>,
        {<span style=color:#e6db74>&#39;form_class&#39;</span>: FullReplyImageForm},
        name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;postman_reply&#39;</span>),
url(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;^messages/view/t/(?P&lt;thread_id&gt;[\d]+)/$&#39;</span>, <span style=color:#e6db74>&#39;postman.views.view_conversation&#39;</span>,
        {<span style=color:#e6db74>&#39;form_class&#39;</span>: FullReplyImageForm},
        name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;postman_view_conversation&#39;</span>),
url(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;^messages/&#39;</span>, include(<span style=color:#e6db74>&#39;postman.urls&#39;</span>)),</code></pre></div></li></ul><p>I’d love to release this publicly but don’t have much experience creating standalone Django apps. If you have experience in open sourcing Django apps let me know - I’d love to get this out there as a standalone app or somehow incorporated into django-postman.</p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2013/05/15/googles-free-adwords-credits/>« Google's “free” Adwords credits</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2013/05/22/save-my-reading-spot-damn-it/>Save my reading spot, damn it »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting();},true);</script><script src=/js/math-code.js></script><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>