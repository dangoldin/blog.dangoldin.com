<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Recursive redirects with AWS Lambda - Dan Goldin
</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="Using AWS's Lambda and API Gateway we can write recursive functions that work by sending state through HTTP redirects."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2016/11/13/recursive-redirects-with-aws-lambda/"><meta property="og:title" content="Recursive redirects with AWS Lambda"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="Using AWS's Lambda and API Gateway we can write recursive functions that work by sending state through HTTP redirects."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Recursive redirects with AWS Lambda"><meta name=twitter:description content="Using AWS's Lambda and API Gateway we can write recursive functions that work by sending state through HTTP redirects."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2016/11/13/recursive-redirects-with-aws-lambda/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-36313127-1")</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Recursive redirects with AWS Lambda</h1><div class="mb-md-4 meta"><span class="date middot" title='Sun Nov 13 2016 00:00:00 UTC'>2016-11-13
</span><span class="reading-time middot">2 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>Two years ago I <a href=http://dangoldin.com/2014/12/31/redirect-recursion/>toyed around</a> with an odd idea of implementing recursion over HTTP redirects. The idea is that the state is managed through the query string arguments and at each recursive step we just redirect to the URL for the next one. I still can’t think of a legitimate use case for this approach but have been on an AWS <a href=https://aws.amazon.com/lambda/>Lambda</a> binge lately and wanted to see whether I can get this “redirect recursion” working under Lambda. Turns out it’s incredibly easy.</p><p>The only question was exposing the Lambda function to the outside world but AWS offers the <a href=https://aws.amazon.com/api-gateway/>API Gateway</a> service to make this happen. This also gave me a chance to mess around with the API Gateway for the first time and definitely has me thinking about entire tools and applications that can be done in a “serverless” way.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>A</span> <span style=color:#a6e22e>simple</span> <span style=color:#a6e22e>Lambda</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>calculate</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>factorial</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>done</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;400&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;200&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>res</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>httpMethod</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Calculate the factorial
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;GET&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>queryStringParameters</span>.<span style=color:#a6e22e>n</span>,<span style=color:#ae81ff>10</span>) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> parseInt(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>queryStringParameters</span>.<span style=color:#a6e22e>a</span>,<span style=color:#ae81ff>10</span>) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>null</span>, {<span style=color:#e6db74>&#39;factorial&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>a</span>});
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>20</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>null</span>, {<span style=color:#e6db74>&#39;status&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;try a smaller number&#39;</span>});
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://rrouzys2ra.execute-api.us-east-1.amazonaws.com/prod/redirect-recursion?&#39;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>args</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;n=&#39;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;&amp;a=&#39;</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>a</span><span style=color:#f92672>*</span><span style=color:#a6e22e>n</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>302</span>,
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;Location&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>url</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>args</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Unsupported method &#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>httpMethod</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;`</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>};</span></span></code></pre></div><p><a href=/image/aws-lambda-resource.png><img src=/image/aws-lambda-stages.png alt="AWS Lambda Stage Setup" data-width=1493 data-height=587 data-layout=responsive></a></p><p class=caption>This connects any request to the /redirect-recursion endpoint to the Lambda function.</p><p><a href=/image/aws-lambda-stages.png><img src=/image/aws-lambda-stages.png alt="AWS Lambda Stage Setup" data-width=1493 data-height=587 data-layout=responsive></a></p><p class=caption>This shows the URL that needs to be invoked to run the recursion.</p></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2016/11/12/a-poor-mans-data-pipeline/>« A poor man's data pipeline</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2016/11/18/comparing-the-web-requests-made-by-the-top-sites-2014-vs-2016/>Comparing the web requests made by the top sites: 2014 vs 2016 »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2024 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener("load",function(){hljs.initHighlighting()},!0)</script><script src=/js/math-code.js></script><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>