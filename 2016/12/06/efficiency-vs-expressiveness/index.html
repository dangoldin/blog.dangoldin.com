<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Efficiency vs expressiveness - Dan Goldin</title><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=referrer content="no-referrer"><meta name=description content="Ideally we can write code that's both efficient and expressive but they're often at odds with one another. I wish there was a language that offered both."><meta property="og:site_name" content="Dan Goldin"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="/2016/12/06/efficiency-vs-expressiveness/"><meta property="og:title" content="Efficiency vs expressiveness"><meta property="og:image" content="/image/photo.jpg"><meta property="og:description" content="Ideally we can write code that's both efficient and expressive but they're often at odds with one another. I wish there was a language that offered both."><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dangoldin"><meta name=twitter:creator content="@dangoldin"><meta name=twitter:title content="Efficiency vs expressiveness"><meta name=twitter:description content="Ideally we can write code that's both efficient and expressive but they're often at odds with one another. I wish there was a language that offered both."><meta name=twitter:image content="/image/photo.jpg"><link rel=canonical href=/2016/12/06/efficiency-vs-expressiveness/><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin=anonymous><link rel=stylesheet href=https://nanx-assets.netlify.app/fonts.css><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicon.png><link href=/index.xml rel=alternate type=application/rss+xml title="Dan Goldin"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36313127-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36313127-1')</script></head><body><div class="my-4 my-lg-5 header"><div class=container><div class=row><div class="col-auto offset-lg-2 d-none d-lg-block"><a href=/><img class="ml-lg-4 logo img-fluid d-block rounded-circle" src=/image/photo.jpg alt=logo></a></div><div class="col-auto align-self-center mr-auto"><a href=/><h1 class=name>Dan Goldin</h1></a><ul class="nav nav-primary"><li class=nav-item><a class="nav-link text-home" href=/>Home</a></li><li class=nav-item><a class="nav-link text-about" href=/about/>About</a></li><li class=nav-item><a class="nav-link text-lore" href=/lore/>Lore</a></li></ul></div></div></div></div><div class=content><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><h1 class="mx-0 mx-md-4 blog-post-title">Efficiency vs expressiveness</h1><div class="mb-md-4 meta"><span class="date middot" title="Tue Dec 6 2016 00:00:00 UTC">2016-12-06</span>
<span class="reading-time middot">5 min read</span><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"><li class="d-inline middot"><a href=/tags/code>code</a></li></ul></div><div class="d-none d-md-inline tags"><ul class="list-unstyled d-inline"></ul></div></div><div class="markdown blog-post-content"><p>The ideal code is both efficient and expressive but they’re often at odds with one another. Last week I was working on a <a href=https://github.com/dangoldin/aws-billing-details-analysis/blob/master/analyze_aws_details.py>simple script</a> to parse and visualize a detailed AWS bill across a variety of dimensions and came across a clear example. The script loads a CSV file into a Pandas dataframe and adds a few columns based on the values of some others. The challenge is that the CSV file can be millions of rows so minor improvements can lead to significant efficiency gains. Given this quick overview the code below should make sense but there are two functions that each iterate through the values of the same column in order to generate two additional columns.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_usage_type_group</span>(self):
        d <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>d
        <span style=color:#75715e># Get rid of the nan</span>
        all_usage_types <span style=color:#f92672>=</span> list(x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> d[<span style=color:#e6db74>&#39;UsageType&#39;</span>]<span style=color:#f92672>.</span>unique() <span style=color:#66d9ef>if</span> type(x) <span style=color:#f92672>==</span> str)
        d[<span style=color:#e6db74>&#39;usage_type_group&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>

        <span style=color:#75715e># Simple group assignment using substring</span>
        usage_groups <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;DataTransfer&#39;</span>, <span style=color:#e6db74>&#39;Requests&#39;</span>, <span style=color:#e6db74>&#39;In-Bytes&#39;</span>, <span style=color:#e6db74>&#39;Out-Bytes&#39;</span>, <span style=color:#e6db74>&#39;BoxUsage&#39;</span>]
        <span style=color:#66d9ef>for</span> usage_type <span style=color:#f92672>in</span> all_usage_types:
            <span style=color:#66d9ef>for</span> usage_group <span style=color:#f92672>in</span> usage_groups:
                <span style=color:#66d9ef>if</span> usage_group <span style=color:#f92672>in</span> usage_type:
                    d<span style=color:#f92672>.</span>usage_type_group[ d[<span style=color:#e6db74>&#39;UsageType&#39;</span>] <span style=color:#f92672>==</span> usage_type ] <span style=color:#f92672>=</span> usage_group
                <span style=color:#66d9ef>continue</span>

    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_instance_type</span>(self):
        d <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>d
        <span style=color:#75715e># Extract from usage type which will be like &#34;APS1-BoxUsage:c4.large&#34;</span>
        all_usage_types <span style=color:#f92672>=</span> list(x <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> d[<span style=color:#e6db74>&#39;UsageType&#39;</span>]<span style=color:#f92672>.</span>unique() <span style=color:#66d9ef>if</span> type(x) <span style=color:#f92672>==</span> str)
        d[<span style=color:#e6db74>&#39;instance_type&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>

        <span style=color:#66d9ef>for</span> usage_type <span style=color:#f92672>in</span> all_usage_types:
            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;BoxUsage&#39;</span> <span style=color:#f92672>in</span> usage_type:
                instance_type <span style=color:#f92672>=</span> usage_type<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;:&#39;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
                d<span style=color:#f92672>.</span>instance_type[ d[<span style=color:#e6db74>&#39;UsageType&#39;</span>] <span style=color:#f92672>==</span> usage_type ] <span style=color:#f92672>=</span> instance_type</code></pre></div><p>As one can see the outer for loop is shared but the inner logic is different. If all I cared about was efficiency I’d be able to combine the two functions but then I’d lose the separation of concerns. I can also rewrite the code to be more functional and have a single method that takes a list of functions to apply as arguments but that would but in this case would look messy. I wish I didn’t have to sacrifice efficiency for expressiveness and would love a language that was smart enough to handle this sort of optimization. The JVM does a series of optimizations as it runs so it may come close but I wonder if there’s any language that can do this optimization at compile time.</p><p>I was also a bit curious about this issue and wrote a toy <a href=https://github.com/dangoldin/code-samples/blob/master/iteration_filter_testing.py>Python script</a> to compare the various implementations of a simple for loop filter. The data reinforces this conflict between efficiency and expressiveness. The script generates a random integer array and then filters it down to two smaller arrays - one for numbers divisible by 100 and one for numbers divisible by 200. The naive way is to do a single for loop and then have if statements for each condition but the slightly improved version is to realize that 200 is a multiple of 100 and one can nest that check. The more Pythonic way of doing these is through a list comprehension and I gave that shot as well. The last attempt was even more functional and do the exercise using a filter/lambda combination.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#! /usr/bin/env python</span>

<span style=color:#f92672>import</span> random
<span style=color:#f92672>import</span> timeit

TEST_LIST_SIZE <span style=color:#f92672>=</span> <span style=color:#ae81ff>100000</span>
NUM_ITERATIONS <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>generate_random_list</span>(size):
    <span style=color:#66d9ef>return</span> random<span style=color:#f92672>.</span>sample(xrange(size), size)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>naive_simple</span>(l):
    a <span style=color:#f92672>=</span> []
    b <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> l:
        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
            a<span style=color:#f92672>.</span>append(i)
        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
            b<span style=color:#f92672>.</span>append(i)
    <span style=color:#66d9ef>return</span> a, b

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>naive_smart</span>(l):
    a <span style=color:#f92672>=</span> []
    b <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> l:
        <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
            a<span style=color:#f92672>.</span>append(i)
            <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
                b<span style=color:#f92672>.</span>append(i)
    <span style=color:#66d9ef>return</span> a, b

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_single</span>(l, n):
    <span style=color:#66d9ef>return</span> [i <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> l <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>]

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_multiple</span>(l, list_n):
    <span style=color:#66d9ef>return</span> [
        [i <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> l <span style=color:#66d9ef>if</span> i <span style=color:#f92672>%</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>] <span style=color:#66d9ef>for</span> n <span style=color:#f92672>in</span> list_n
    ]

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_lambda_single</span>(l, n):
    <span style=color:#66d9ef>return</span> filter(<span style=color:#66d9ef>lambda</span> x: x <span style=color:#f92672>%</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>, l)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>naive_simple_test</span>():
    l <span style=color:#f92672>=</span> generate_random_list(TEST_LIST_SIZE)
    a, b <span style=color:#f92672>=</span> naive_simple(l)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>naive_smart_test</span>():
    l <span style=color:#f92672>=</span> generate_random_list(TEST_LIST_SIZE)
    a1, b1 <span style=color:#f92672>=</span> naive_smart(l)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_single_test</span>():
    l <span style=color:#f92672>=</span> generate_random_list(TEST_LIST_SIZE)
    a2, b2 <span style=color:#f92672>=</span> filter_single(l, <span style=color:#ae81ff>100</span>), filter_single(l, <span style=color:#ae81ff>200</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_multiple_test</span>():
    l <span style=color:#f92672>=</span> generate_random_list(TEST_LIST_SIZE)
    a3, b3 <span style=color:#f92672>=</span> filter_multiple(l, [<span style=color:#ae81ff>100</span>,<span style=color:#ae81ff>200</span>])

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>filter_lambda_single_test</span>():
    l <span style=color:#f92672>=</span> generate_random_list(TEST_LIST_SIZE)
    a4, b4 <span style=color:#f92672>=</span> filter_lambda_single(l, <span style=color:#ae81ff>100</span>), filter_lambda_single(l, <span style=color:#ae81ff>200</span>)

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    l <span style=color:#f92672>=</span> generate_random_list(TEST_LIST_SIZE)

    a, b <span style=color:#f92672>=</span> naive_simple(l)

    a1, b1 <span style=color:#f92672>=</span> naive_smart(l)

    a2, b2 <span style=color:#f92672>=</span> filter_single(l, <span style=color:#ae81ff>100</span>), filter_single(l, <span style=color:#ae81ff>200</span>)

    a3, b3 <span style=color:#f92672>=</span> filter_multiple(l, [<span style=color:#ae81ff>100</span>,<span style=color:#ae81ff>200</span>])

    a4, b4 <span style=color:#f92672>=</span> filter_lambda_single(l, <span style=color:#ae81ff>100</span>), filter_lambda_single(l, <span style=color:#ae81ff>200</span>)

    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Comparison tests&#39;</span>
    <span style=color:#66d9ef>print</span> a <span style=color:#f92672>==</span> a1
    <span style=color:#66d9ef>print</span> b <span style=color:#f92672>==</span> b1

    <span style=color:#66d9ef>print</span> a1 <span style=color:#f92672>==</span> a2
    <span style=color:#66d9ef>print</span> b1 <span style=color:#f92672>==</span> b2

    <span style=color:#66d9ef>print</span> a2 <span style=color:#f92672>==</span> a3
    <span style=color:#66d9ef>print</span> b2 <span style=color:#f92672>==</span> b3

    <span style=color:#66d9ef>print</span> a3 <span style=color:#f92672>==</span> a4
    <span style=color:#66d9ef>print</span> b3 <span style=color:#f92672>==</span> b4

    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Timing tests&#39;</span>
    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Array generation&#39;</span>, timeit<span style=color:#f92672>.</span>timeit(<span style=color:#e6db74>&#39;generate_random_list(TEST_LIST_SIZE)&#39;</span>, <span style=color:#e6db74>&#39;from __main__ import generate_random_list, TEST_LIST_SIZE&#39;</span>, number<span style=color:#f92672>=</span>NUM_ITERATIONS)
    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Naive simple&#39;</span>, timeit<span style=color:#f92672>.</span>timeit(<span style=color:#e6db74>&#39;naive_simple_test()&#39;</span>, <span style=color:#e6db74>&#39;from __main__ import naive_simple_test&#39;</span>, number<span style=color:#f92672>=</span>NUM_ITERATIONS)
    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Naive smart&#39;</span>, timeit<span style=color:#f92672>.</span>timeit(<span style=color:#e6db74>&#39;naive_smart_test()&#39;</span>, <span style=color:#e6db74>&#39;from __main__ import naive_smart_test&#39;</span>, number<span style=color:#f92672>=</span>NUM_ITERATIONS)
    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Filter single&#39;</span>, timeit<span style=color:#f92672>.</span>timeit(<span style=color:#e6db74>&#39;filter_single_test()&#39;</span>, <span style=color:#e6db74>&#39;from __main__ import filter_single_test&#39;</span>, number<span style=color:#f92672>=</span>NUM_ITERATIONS)
    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Filter multiple&#39;</span>, timeit<span style=color:#f92672>.</span>timeit(<span style=color:#e6db74>&#39;filter_multiple_test()&#39;</span>, <span style=color:#e6db74>&#39;from __main__ import filter_multiple_test&#39;</span>, number<span style=color:#f92672>=</span>NUM_ITERATIONS)
    <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;Filter lambda single&#39;</span>, timeit<span style=color:#f92672>.</span>timeit(<span style=color:#e6db74>&#39;filter_lambda_single_test()&#39;</span>, <span style=color:#e6db74>&#39;from __main__ import filter_lambda_single_test&#39;</span>, number<span style=color:#f92672>=</span>NUM_ITERATIONS)</code></pre></div><p>The benchmarks are below and the results are intuitive. The quickest implementation was the single for loop with the nested if conditions and the slowest was the filter/lambda approach. Surprisingly, the other approaches were similar despite the single naive for loop only iterating over the array once while the list comprehensions iterating over the array twice. If we increase the size of the array we do see a bigger benefit coming from the single pass over the array.</p><h4 id=array-size-10000-iterations-10000>Array size: 10,000; Iterations: 10,000</h4><table><thead><tr><th>Implementation</th><th>Time (sec)</th></tr></thead><tbody><tr><td>Array generation</td><td>56.21</td></tr><tr><td>Naive simple</td><td>73.51</td></tr><tr><td>Naive smart</td><td>64.11</td></tr><tr><td>Filter single</td><td>71.92</td></tr><tr><td>Filter multiple</td><td>71.19</td></tr><tr><td>Filter lambda single</td><td>91.34</td></tr></tbody></table><h4 id=array-size-100000-iterations-1000>Array size: 100,000; Iterations: 1,000</h4><table><thead><tr><th>Implementation</th><th>Time (sec)</th></tr></thead><tbody><tr><td>Array generation</td><td>63.96</td></tr><tr><td>Naive simple</td><td>78.74</td></tr><tr><td>Naive smart</td><td>71.13</td></tr><tr><td>Filter single</td><td>82.19</td></tr><tr><td>Filter multiple</td><td>81.86</td></tr><tr><td>Filter lambda single</td><td>109.44</td></tr></tbody></table></div><div class=navigation><div class=row><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-left"><a href=/2016/12/03/read-the-release-notes/>« Read the release notes</a></div></div><div class="col-12 col-lg-6"><div class="mx-0 mx-md-4 mt-4 text-right"><a href=/2016/12/09/its-donation-season/>It's donation season »</a></div></div></div></div></div></div></div></div><section id=comments><div class="py-3 content"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><div class=comments><script src=https://utteranc.es/client.js repo=dangoldin/blog.dangoldin.com-comments issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div></div></section><div class="my-4 footer"><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-lg-8"><hr></div></div><div class="row justify-content-center"><div class="col-sm-12 col-lg-2"><div class="mx-0 mx-md-4 site-copyright">© 2021 Dan Goldin</div></div><div class="col-sm-12 col-lg-6"><div class="mx-0 mx-md-4 site-social"><ul><li><a href=mailto:dan@dangoldin.com>Contact</a></li><li><a href=https://github.com/dangoldin target=_blank>GitHub</a></li><li><a href=https://twitter.com/dangoldin target=_blank>Twitter</a></li><li><a href=https://www.linkedin.com/in/dangoldin target=_blank>LinkedIn</a></li><li><a href=/index.xml class=mr-0>RSS</a></li></ul></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js defer></script><script>window.addEventListener('load',function(){hljs.initHighlighting()},!0)</script></body></html>